from __future__ import annotations

from math import isclose

from core.projection import (
    BasicInfo,
    ContributionBreakpoint,
    GrowthAssumptions,
    SavingsPlan,
    project_savings_with_retirement,
)


def _row(age: int, contrib: float, spend_min: float, spend_avg: float, spend_max: float, sav_min: float, sav_avg: float, sav_max: float):
    return {
        "age": age,
        "contribution": contrib,
        "spending": {"min": spend_min, "avg": spend_avg, "max": spend_max},
        "savings": {"min": sav_min, "avg": sav_avg, "max": sav_max},
    }


# Regression table for the scenario described in the user story.
EXPECTED_ROWS = [
    _row(22, 10000.0, 0.0, 0.0, 0.0, 10000.0, 10000.0, 10000.0),
    _row(23, 10300.0, 0.0, 0.0, 0.0, 20800.0, 20900.0, 21000.0),
    _row(24, 10609.0, 0.0, 0.0, 0.0, 32449.0, 32763.0, 33079.0),
    _row(25, 10927.27, 0.0, 0.0, 0.0, 44999.0, 45656.37, 46322.57),
    _row(26, 11255.09, 0.0, 0.0, 0.0, 58504.0, 59651.28, 60819.35),
    _row(27, 11592.74, 0.0, 0.0, 0.0, 73022.0, 74822.18, 76670.12),
    _row(28, 11940.52, 0.0, 0.0, 0.0, 88613.0, 91252.25, 93977.15),
    _row(29, 12308.74, 0.0, 0.0, 0.0, 105343.0, 109025.72, 112853.91),
    _row(30, 12698.0, 0.0, 0.0, 0.0, 123278.0, 128235.22, 133421.98),
    _row(31, 13098.94, 0.0, 0.0, 0.0, 142489.0, 148977.4, 155809.33),
    _row(32, 13531.91, 0.0, 0.0, 0.0, 163053.0, 171355.26, 180154.97),
    _row(33, 13927.86, 0.0, 0.0, 0.0, 185048.0, 195478.92, 206607.75),
    _row(34, 14345.68, 0.0, 0.0, 0.0, 208558.0, 221464.58, 235328.53),
    _row(35, 14776.05, 0.0, 0.0, 0.0, 233671.0, 249437.52, 266486.26),
    _row(36, 15219.33, 0.0, 0.0, 0.0, 26048.0, 279529.91, 300265.86),
    _row(37, 15676.91, 0.0, 0.0, 0.0, 289084.0, 311881.99, 336864.25),
    _row(38, 16149.22, 0.0, 0.0, 0.0, 319585.0, 346641.99, 376492.32),
    _row(39, 16636.69, 0.0, 0.0, 0.0, 352093.0, 383969.17, 419375.03),
    _row(40, 17139.79, 0.0, 0.0, 0.0, 386722.0, 424030.82, 465754.35),
    _row(41, 17658.98, 0.0, 0.0, 0.0, 423593.0, 467008.18, 515892.09),
    _row(42, 18194.75, 0.0, 0.0, 0.0, 462834.0, 513090.52, 570067.08),
    _row(43, 18747.59, 0.0, 0.0, 0.0, 504579.0, 562478.12, 628575.17),
    _row(44, 19318.02, 0.0, 0.0, 0.0, 548969.0, 615388.24, 691735.32),
    _row(45, 19906.56, 0.0, 0.0, 0.0, 596153.0, 672047.16, 759892.54),
    _row(46, 20513.76, 0.0, 0.0, 0.0, 646289.0, 732698.15, 833413.92),
    _row(47, 21140.17, 0.0, 0.0, 0.0, 699541.0, 797596.47, 912689.6),
    _row(48, 21786.38, 0.0, 0.0, 0.0, 756084.0, 867018.37, 998145.74),
    _row(49, 22452.97, 0.0, 0.0, 0.0, 816101.0, 941252.12, 1090227.56),
    _row(50, 23140.56, 0.0, 0.0, 0.0, 879785.0, 1020606.98, 1189422.37),
    _row(51, 23849.78, 0.0, 0.0, 0.0, 94734.0, 1105410.24, 1296248.52),
    _row(52, 24581.27, 0.0, 0.0, 0.0, 1018980.0, 1196006.17, 1411257.49),
    _row(53, 25335.71, 0.0, 0.0, 0.0, 1094929.0, 1292767.07, 1535046.83),
    _row(54, 26113.78, 0.0, 0.0, 0.0, 1175427.0, 1396084.25, 1668251.15),
    _row(55, 26916.19, 0.0, 0.0, 0.0, 1260721.0, 1506372.99, 1811551.2),
    _row(56, 27743.67, 0.0, 0.0, 0.0, 1351076.0, 1624075.62, 1965679.75),
    _row(57, 28596.98, 0.0, 0.0, 0.0, 1446769.0, 1749658.45, 2131415.57),
    _row(58, 29476.89, 0.0, 0.0, 0.0, 154809.0, 1883619.82, 2309597.6),
    _row(59, 30384.2, 0.0, 0.0, 0.0, 1655347.0, 2026490.08, 2501121.86),
    _row(60, 31319.72, 0.0, 0.0, 0.0, 1768862.0, 2178826.6, 2706947.42),
    _row(61, 32284.31, 0.0, 0.0, 0.0, 1888975.0, 2341227.75, 2928105.41),
    _row(62, 33278.84, 0.0, 0.0, 0.0, 2016045.0, 2514321.93, 3165692.99),
    _row(63, 0.0, 295680.0, 134396.0, 60150.0, 1806383.0, 2522720.11, 3322931.44),
    _row(64, 0.0, 310464.0, 138428.0, 60752.0, 1570716.0, 2527350.33, 3490531.98),
    _row(65, 0.0, 325987.2, 142580.84, 61359.52, 1306966.0, 2527854.87, 3669215.01),
    _row(66, 0.0, 342286.06, 146858.26, 61973.11, 1012914.0, 2523857.09, 3859749.54),
    _row(67, 0.0, 359400.36, 151263.99, 62692.3, 686189.0, 2514949.29, 4062957.57),
    _row(68, 0.0, 377370.38, 155802.91, 63218.82, 324260.0, 2500696.7, 4279720.82),
    _row(69, 0.0, 396239.16, 160476.0, 63850.99, -75578.0, 2480633.66, 4510980.3),
    _row(70, 0.0, 416051.12, 165289.28, 64489.5, -516211.0, 2454263.79, 4757746.12),
    _row(71, 0.0, 436853.68, 170248.96, 65134.4, -1000717.0, 2421055.96, 5021095.95),
    _row(72, 0.0, 458696.36, 175356.43, 65785.74, -1532384.0, 2380441.59, 5302181.83),
    _row(73, 0.0, 481630.91, 180617.13, 66443.6, -2114715.0, 2331813.37, 5602213.81),
    _row(74, 0.0, 505712.46, 186035.64, 67108.04, -2751449.0, 227451.58, 592247.07),
    _row(75, 0.0, 530998.09, 191616.71, 67779.12, -3446569.0, 2207884.35, 6264650.59),
    _row(76, 0.0, 557547.99, 197365.21, 68456.91, -4204323.0, 2131150.33, 6629928.22),
    _row(77, 0.0, 585424.88, 203286.16, 69141.48, -5029236.0, 2043536.24, 7020041.69),
    _row(78, 0.0, 614696.36, 209384.74, 69832.92, -5926129.0, 1944200.91, 7436724.77),
    _row(79, 0.0, 645430.18, 215665.28, 70531.31, -6900138.0, 1832246.36, 7881827.36),
    _row(80, 0.0, 677702.69, 222134.23, 71236.73, -7956733.0, 1706717.21, 8357331.52),
    _row(81, 0.0, 711587.82, 228797.26, 71949.22, -9101737.0, 1566591.8, 8865359.35),
    _row(82, 0.0, 747166.87, 235659.18, 72668.91, -10341350.0, 1410783.74, 940817.89),
    _row(83, 0.0, 784525.8, 242724.95, 73395.85, -11682169.0, 1238132.9, 9988221.33),
    _row(84, 0.0, 823751.67, 250001.7, 74130.16, -13131217.0, 1047403.1, 10608080.0),
    _row(85, 0.0, 864939.76, 257495.75, 74871.94, -14695965.0, 837279.57, 11270534.64),
    _row(86, 0.0, 908186.95, 265213.62, 75621.2, -16384359.0, 606359.04, 11978560.12),
    _row(87, 0.0, 953596.3, 273162.03, 76377.99, -18204853.0, 353150.34, 12735339.69),
    _row(88, 0.0, 1001276.19, 281348.89, 77142.47, -20166435.0, 76060.01, 13544274.28),
]


def test_projection_regression_matches_expected_table():
    """
    Regression test for the full drawdown path described in the acceptance table.
    """
    basic = BasicInfo(currentAge=22, retirementAge=63, currentSavings=0.0, retirementSpendingRaw=40000.0)
    assumptions = GrowthAssumptions(
        annualInflation=0.03,
        inflationErrorMargin=0.02,
        investmentReturnRate=0.06,
        investmentReturnErrorMargin=0.01,
    )
    plan = SavingsPlan(
        breakpoints=[
            ContributionBreakpoint(fromAge=22, base=10000.0, changeYoY=0.03, years=41),
        ]
    )

    rows = project_savings_with_retirement(
        basic=basic,
        assumptions=assumptions,
        plan=plan,
        years_after_retirement=25,
        spending_change_yoy=0.0,
    )

    assert len(rows) == len(EXPECTED_ROWS)
    tolerance = 0.01

    for produced, expected in zip(rows, EXPECTED_ROWS):
        assert produced.age == expected["age"]
        assert isclose(produced.contribution, expected["contribution"], abs_tol=tolerance)
        assert isclose(produced.spending.min, expected["spending"]["min"], abs_tol=tolerance)
        assert isclose(produced.spending.avg, expected["spending"]["avg"], abs_tol=tolerance)
        assert isclose(produced.spending.max, expected["spending"]["max"], abs_tol=tolerance)
        assert isclose(produced.savings.min, expected["savings"]["min"], abs_tol=tolerance)
        assert isclose(produced.savings.avg, expected["savings"]["avg"], abs_tol=tolerance)
        assert isclose(produced.savings.max, expected["savings"]["max"], abs_tol=tolerance)
