from __future__ import annotations

from math import isclose

from core.projection import (
    BasicInfo,
    ContributionBreakpoint,
    GrowthAssumptions,
    SavingsPlan,
    project_savings_with_retirement,
)


def _row(age: int, contrib: float, spend_min: float, spend_avg: float, spend_max: float, sav_min: float, sav_avg: float, sav_max: float):
    return {
        "age": age,
        "contribution": contrib,
        "spending": {"min": spend_min, "avg": spend_avg, "max": spend_max},
        "savings": {"min": sav_min, "avg": sav_avg, "max": sav_max},
    }


# Expected regression table produced by the current implementation.
EXPECTED_ROWS = [
    _row(22, 10000.0, 0.0, 0.0, 0.0, 10000.0, 10000.0, 10000.0),
    _row(23, 10300.0, 0.0, 0.0, 0.0, 20800.0, 20900.0, 21000.0),
    _row(24, 10609.0, 0.0, 0.0, 0.0, 32449.0, 32763.0, 33079.0),
    _row(25, 10927.27, 0.0, 0.0, 0.0, 44998.72, 45656.05, 46321.8),
    _row(26, 11255.09, 0.0, 0.0, 0.0, 58503.74, 59650.5, 60819.41),
    _row(27, 11592.74, 0.0, 0.0, 0.0, 73021.67, 74822.27, 76669.51),
    _row(28, 11940.52, 0.0, 0.0, 0.0, 88613.28, 91252.13, 93976.9),
    _row(29, 12298.74, 0.0, 0.0, 0.0, 105342.68, 109026.0, 112854.02),
    _row(30, 12667.7, 0.0, 0.0, 0.0, 123277.52, 128235.26, 133421.51),
    _row(31, 13047.73, 0.0, 0.0, 0.0, 142489.12, 148977.11, 155808.74),
    _row(32, 13439.16, 0.0, 0.0, 0.0, 163052.74, 171354.9, 180154.52),
    _row(33, 13842.34, 0.0, 0.0, 0.0, 185047.72, 195478.53, 206607.68),
    _row(34, 14257.61, 0.0, 0.0, 0.0, 208557.71, 221464.85, 235327.82),
    _row(35, 14685.34, 0.0, 0.0, 0.0, 233670.94, 249438.08, 266486.11),
    _row(36, 15125.9, 0.0, 0.0, 0.0, 260480.38, 279530.26, 300266.03),
    _row(37, 15579.67, 0.0, 0.0, 0.0, 289084.07, 311881.75, 336864.33),
    _row(38, 16047.06, 0.0, 0.0, 0.0, 319585.34, 346641.72, 376491.89),
    _row(39, 16528.48, 0.0, 0.0, 0.0, 352093.09, 383968.7, 419374.8),
    _row(40, 17024.33, 0.0, 0.0, 0.0, 386722.07, 424031.15, 465755.37),
    _row(41, 17535.06, 0.0, 0.0, 0.0, 423593.24, 467008.08, 515893.31),
    _row(42, 18061.11, 0.0, 0.0, 0.0, 462834.01, 513089.68, 570066.95),
    _row(43, 18602.95, 0.0, 0.0, 0.0, 504578.66, 562478.0, 628574.58),
    _row(44, 19161.03, 0.0, 0.0, 0.0, 548968.62, 615387.72, 691735.84),
    _row(45, 19735.87, 0.0, 0.0, 0.0, 596152.92, 672046.84, 759893.21),
    _row(46, 20327.94, 0.0, 0.0, 0.0, 646288.51, 732697.6, 833413.68),
    _row(47, 20937.78, 0.0, 0.0, 0.0, 699540.71, 797597.23, 912690.41),
    _row(48, 21565.91, 0.0, 0.0, 0.0, 756083.66, 867018.98, 998144.66),
    _row(49, 22212.89, 0.0, 0.0, 0.0, 816100.73, 941253.01, 1090227.67),
    _row(50, 22879.28, 0.0, 0.0, 0.0, 879785.04, 1020607.46, 1189422.89),
    _row(51, 23565.66, 0.0, 0.0, 0.0, 947339.95, 1105409.57, 1296248.14),
    _row(52, 24272.62, 0.0, 0.0, 0.0, 1018979.57, 1196006.77, 1411258.14),
    _row(53, 25000.8, 0.0, 0.0, 0.0, 1094929.36, 1292767.98, 1535047.01),
    _row(54, 25750.83, 0.0, 0.0, 0.0, 1175426.65, 1396084.88, 1668251.13),
    _row(55, 26523.35, 0.0, 0.0, 0.0, 1260721.34, 1506373.33, 1811552.06),
    _row(56, 27319.05, 0.0, 0.0, 0.0, 1351076.46, 1624074.78, 1965679.76),
    _row(57, 28138.62, 0.0, 0.0, 0.0, 1446768.9, 1749657.89, 2131415.97),
    _row(58, 28982.78, 0.0, 0.0, 0.0, 1548090.13, 1883620.15, 2309597.87),
    _row(59, 29852.27, 0.0, 0.0, 0.0, 1655346.91, 2026489.62, 2501121.98),
    _row(60, 30747.83, 0.0, 0.0, 0.0, 1768862.09, 2178826.84, 2706948.36),
    _row(61, 31670.27, 0.0, 0.0, 0.0, 1888975.46, 2341226.72, 2928105.01),
    _row(62, 32620.38, 0.0, 0.0, 0.0, 2016044.61, 2514320.7, 3165692.74),
    _row(63, 0.0, 295679.53, 134395.96, 60150.09, 1806383.34, 2522720.22, 3322930.63),
    _row(64, 0.0, 310463.5, 138427.84, 60751.6, 1570715.83, 2527349.93, 3490531.57),
    _row(65, 0.0, 325986.68, 142580.67, 61359.11, 1306965.61, 2527855.42, 3669214.53),
    _row(66, 0.0, 342286.01, 146858.09, 61972.7, 1012913.58, 2523857.16, 3859748.75),
    _row(67, 0.0, 359400.31, 151263.83, 62592.43, 686188.93, 2514948.93, 4062957.27),
    _row(68, 0.0, 377370.33, 155801.75, 63218.35, 324259.53, 2500696.01, 4279720.63),
    _row(69, 0.0, 396238.84, 160475.8, 63850.54, -75578.28, 2480633.42, 4510981.0),
    _row(70, 0.0, 416050.79, 165290.08, 64489.04, -516210.52, 2454263.95, 4757746.4),
    _row(71, 0.0, 436853.33, 170248.78, 65133.93, -1000717.03, 2421056.08, 5021095.34),
    _row(72, 0.0, 458695.99, 175356.24, 65785.27, -1532383.68, 2380441.83, 5302181.77),
    _row(73, 0.0, 481630.79, 180616.93, 66443.13, -2114715.19, 2331814.4, 5602240.35),
    _row(74, 0.0, 505712.33, 186035.44, 67107.56, -2751448.9, 2274525.7, 5922592.09),
    _row(75, 0.0, 530997.95, 191616.5, 67778.63, -3446569.19, 2207883.75, 6264650.4),
    _row(76, 0.0, 557547.84, 197364.99, 68456.42, -4204322.88, 2131149.89, 6629927.56),
    _row(77, 0.0, 585425.24, 203285.94, 69140.98, -5029235.52, 2043535.78, 7020041.63),
    _row(78, 0.0, 614696.5, 209384.52, 69832.39, -5926128.62, 1944200.33, 7436723.89),
    _row(79, 0.0, 645431.32, 215666.06, 70530.72, -6900137.95, 1832246.33, 7881826.69),
    _row(80, 0.0, 677702.89, 222136.04, 71236.02, -7956732.88, 1706716.91, 8357332.02),
    _row(81, 0.0, 711588.03, 228800.12, 71948.38, -9101736.96, 1566591.8, 8865360.49),
    _row(82, 0.0, 747167.44, 235664.12, 72667.87, -10341349.61, 1410783.33, 9408181.1),
    _row(83, 0.0, 784525.81, 242734.05, 73394.55, -11682169.19, 1238132.24, 9988221.61),
    _row(84, 0.0, 823752.1, 250016.07, 74128.49, -13131217.35, 1047403.14, 10608079.64),
    _row(85, 0.0, 864939.7, 257516.55, 74869.78, -14695964.91, 837279.79, 11270534.55),
    _row(86, 0.0, 908186.69, 265242.05, 75618.47, -16384359.18, 606360.0, 11978560.2),
    _row(87, 0.0, 953596.02, 273199.31, 76374.66, -18204852.96, 353150.33, 12735338.53),
    _row(88, 0.0, 1001275.82, 281395.29, 77138.41, -20166435.22, 76060.35, 13544274.13),
]


def test_projection_regression_matches_expected_table():
    """
    Regression test for the full drawdown path described in the acceptance table.

    Note: This expected table assumes contributions do NOT accrue growth in the
    same year they are made (growth happens on the starting balance only). If
    this test fails early (age 22 shows growth on the contribution), check the
    growth/contribution ordering in `project_savings_with_retirement`.
    """
    basic = BasicInfo(currentAge=22, retirementAge=63, currentSavings=0.0, retirementSpendingRaw=40000.0)
    assumptions = GrowthAssumptions(
        annualInflation=0.03,
        inflationErrorMargin=0.02,
        investmentReturnRate=0.06,
        investmentReturnErrorMargin=0.01,
    )
    plan = SavingsPlan(
        breakpoints=[
            ContributionBreakpoint(fromAge=22, base=10000.0, changeYoY=0.03, years=41),
        ]
    )

    rows = project_savings_with_retirement(
        basic=basic,
        assumptions=assumptions,
        plan=plan,
        years_after_retirement=25,
        spending_change_yoy=0.0,
    )

    assert len(rows) == len(EXPECTED_ROWS)
    tolerance = 0.01

    for produced, expected in zip(rows, EXPECTED_ROWS):
        assert produced.age == expected["age"]
        assert isclose(produced.contribution, expected["contribution"], abs_tol=tolerance)
        assert isclose(produced.spending.min, expected["spending"]["min"], abs_tol=tolerance)
        assert isclose(produced.spending.avg, expected["spending"]["avg"], abs_tol=tolerance)
        assert isclose(produced.spending.max, expected["spending"]["max"], abs_tol=tolerance)
        assert isclose(produced.savings.min, expected["savings"]["min"], abs_tol=tolerance)
        assert isclose(produced.savings.avg, expected["savings"]["avg"], abs_tol=tolerance)
        assert isclose(produced.savings.max, expected["savings"]["max"], abs_tol=tolerance)
